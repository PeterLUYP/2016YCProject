{% extends "base.html" %}

{% block title %}活動管理{% endblock %}

{% block activityButton %}
	<li class="active"><a href="/activity">活動管理</a></li>
{% endblock %}
{% block content %}
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">新增活動</h3>
		</div>
		<div class="panel-body">
			<label>活動名稱：<input type="text" id="nameAddInput"></input></label>
			<label>活動內容：<input type="text" id="contentAddInput"></input></label><p></p>
			<label>開始日期：<input type="date" id="startAddInput"></input></label>
			<label>結束日期(需大或等於開始日期)：<input type="date" id="endAddInput"></input></label>
			<label>清除日期(需大於結束日期)：<input type="date" id="deleteAddInput"></input></label>
			<button type="button" onclick="addNewActivity()" class="btn btn-default" id="addNewActivityBtn">新增</button>
		</div>
	</div>
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">編輯區域</h3>
		</div>
		<div class="panel-body" id="updateActivityArea">
			請選擇資料以編輯。
		</div>
	</div>
	<div class="panel panel-success">
		<div class="panel-heading">
			<h3 class="panel-title">成功新增活動</h3>
		</div>
		<div class="panel-body">
			<table class="table table-hover" id="myTable">
				<thead>
			        <tr>
			          <th>活動名稱</th>
			          <th>活動內容</th>
			          <th>開始日期</th>
			          <th>結束日期</th>
			          <th>清除日期</th>
			          <th>編輯</th>
			        </tr>
			    </thead>
			    <tbody>
			    </tbody>
			</table>
		</div>
	</div>
{% endblock %}
{% block script %}
	<script type="text/javascript">
		var myFirebaseRef = new Firebase('https://activity-a59ea.firebaseio.com/');
		function beforeCheck() {
			addNewActivity();
		}
		function addNewActivity() {
			var name = $('#nameAddInput').val();
			var content = $('#contentAddInput').val();
			var startDate = document.getElementById('startAddInput').value;
			var endDate = document.getElementById('endAddInput').value;
			var deleteDate = document.getElementById('deleteAddInput').value;
			var newAddActivity = myFirebaseRef.push({
				"Name": name,
				"Content": content,
				"Period": {
					"StartDate": startDate,
					"EndDate": endDate,
					"DeleteDate": deleteDate
				}
			});
			$('#nameAddInput').val("");
			$('#contentAddInput').val("");
			$('#startAddInput').val("");
			$('#endAddInput').val("");	
			$('#deleteAddInput').val("");
		};

		myFirebaseRef.once("value", function(snapshot) {
	  		var childNum = snapshot.numChildren();
  			myFirebaseRef.orderByChild("Name").limitToLast(10).on("child_added", function(snapshot, prevChildKey) {
				var activity = snapshot.val();
				add_new_data(activity.Name, activity.Content, activity.Period.StartDate, activity.Period.EndDate, activity.Period.DeleteDate, snapshot.key());
			});
		});

		function add_new_data(name, content, start, end, del, key) {
			//先取得目前的row數
			var num = document.getElementById("myTable").rows.length;
			//建立新的tr 因為是從0開始算 所以目前的row數剛好為目前要增加的第幾個tr
			var Tr = document.getElementById("myTable").insertRow(-1);
			//建立新的td 而Tr.cells.length就是這個tr目前的td數
			Td = Tr.insertCell(Tr.cells.length);
			//而這個就是要填入td中的innerHTML	
			Td.innerHTML=name;
			//這裡也可以用不同的變數來辨別不同的td (我是用同一個比較省事XD)
			Td = Tr.insertCell(Tr.cells.length);
			Td.innerHTML=content;
			//這樣就好囉 記得td數目要一樣 不然會亂掉~
			Td = Tr.insertCell(Tr.cells.length);
			Td.innerHTML=start;
			Td = Tr.insertCell(Tr.cells.length);
			Td.innerHTML=end;
			Td = Tr.insertCell(Tr.cells.length);
			Td.innerHTML=del;
			Td = Tr.insertCell(Tr.cells.length);
			Td.innerHTML='<button type="button" class="btn btn-primary" onclick="updateActivity(' + "'" + key + "'" + ')">編輯</button> <button type="button" class="btn btn-danger" onclick="deleteActivity(' + "'" + key + "'" + ')">刪除</button>';
		}

		function updateActivity(key) {
			var newFirebaseRef = new Firebase('hhttps://activity-a59ea.firebaseio.com/' + key);
			newFirebaseRef.once("value")
			  .then(function(snapshot) {
			    var name = snapshot.child("Name").val();
			    var content = snapshot.child("Content").val();
			    var start = snapshot.child("Period").child("StartDate").val();
			    var end = snapshot.child("Period").child("EndDate").val();
			    var del = snapshot.child("Period").child("DeleteDate").val();
			    document.getElementById("updateActivityArea").innerHTML = '<label>活動名稱：<input type="text" id="nameUpdate" value="' + name + '"></label><label>活動內容：<input type="text" id="contentUpdate" value="' + content + '"></label><label>開始日期：<input type="date" id="startUpdate" value="' + start + '"></label><label>結束日期(需大或等於開始日期)：<input type="date" id="endUpdate" value="' + end + '"></label><label>清除日期(需大於結束日期)：<input type="date" id="deleteUpdate" value="' + del + '"></label> <button type="button" class="btn btn-default" onclick="saveUpdatedActivity(' + "'" + key + "'" + ')">確認編輯</button>';
			  });
		}

		function saveUpdatedActivity(key){
			var newFirebaseRef = new Firebase('https://activity-a59ea.firebaseio.com/' + key);
			var name = $('#nameUpdate').val();
			var content = $('#contentUpdate').val();
			var startDate = document.getElementById('startUpdate').value;
			var endDate = document.getElementById('endUpdate').value;
			var deleteDate = document.getElementById('deleteUpdate').value;
			newFirebaseRef.update({
				"Name": name,
				"Content": content,
				"Period": {
					"StartDate": startDate,
					"EndDate": endDate,
					"DeleteDate": deleteDate
				}
			});
			window.location.reload();
		}

		function deleteActivity(key) {
			var newFirebaseRef = new Firebase('https://activity-a59ea.firebaseio.com/' + key);
			newFirebaseRef.remove();
			window.location.reload();
		}
	</script>
{% endblock %}